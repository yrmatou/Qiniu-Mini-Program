!function(e,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports["qiniu-mini-program"]=i():e["qiniu-mini-program"]=i()}(self,(function(){return(()=>{"use strict";var e={d:(i,n)=>{for(var o in n)e.o(n,o)&&!e.o(i,o)&&Object.defineProperty(i,o,{enumerable:!0,get:n[o]})},o:(e,i)=>Object.prototype.hasOwnProperty.call(e,i),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},i={};e.r(i),e.d(i,{setConfig:()=>u,upload:()=>a});const n={qiniuShouldUseQiniuFileName:!0,qiniuRegion:"ECN",qiniuBucketURLPrefix:"",qiniuUploadToken:"",qiniuUploadTokenUrl:""},o={uni};let t=!1;const r=o.uni;function u(e){if(t=!0,!e||!e.region)return Promise.reject("qiniu config params error");const i={shouldUseQiniuFileName:"qiniuShouldUseQiniuFileName",region:"qiniuRegion",upToken:"qiniuUploadToken",upTokenUrl:"qiniuUploadTokenUrl",domain:"qiniuBucketURLPrefix"};return Object.keys(e).forEach((o=>{i[o]&&(n[i[o]]=e[o]||"")})),Promise.resolve()}function a({filePath:e,options:i,update:o=!1,progress:a,cancelTask:s}){return new Promise((async(l,c)=>{try{if(!e)return c("filePath is null");!i||t&&!o||await u(i),await new Promise((async(e,i)=>n.qiniuUploadToken?e("success"):n.qiniuUploadTokenUrl?(await new Promise(((e,i)=>{r.request({url:n.qiniuUploadTokenUrl,success:o=>{const t=o.data.upToken;if(t&&t.length>0)return n.qiniuUploadToken=t,n.qiniuBucketURLPrefix=o.data.domain,n.qiniuRegion=o.data.region,e("success");i("qiniuUploader cannot get your token, please check the upTokenUrl or server")},fail:e=>{i("qiniu UploadToken is null, please check the init config or networking: "+e)}})})),e("success")):void i("qiniu uploader need upToken or upTokenUrl")));const p=await function({filePath:e,options:i,progress:o,cancelTask:t}){return new Promise((async(u,a)=>{if(!n.qiniuUploadToken)return a("qiniu uploadToken is null, please check the init config or networking");const s=await function(e){const i=new Map([["ECN","https://upload.qiniup.com"],["ECNZ","https://upload-cn-east-2.qiniup.com"],["NCN","https://upload-z1.qiniup.com"],["SCN","https://upload-z2.qiniup.com"],["NA","https://upload-na0.qiniup.com"],["ASG","https://upload-as0.qiniup.com"]]);return i.has(e)?Promise.resolve(i.get(e)):Promise.reject("region code empty")}(n.qiniuRegion);let l=e.split("//")[1];i&&i.key&&(l=i.key);let c={token:n.qiniuUploadToken};n.qiniuShouldUseQiniuFileName||(c.key=l);const p=r.uploadFile({url:s,filePath:e,name:"file",formData:c,success:e=>{try{if(200!==e.statusCode)return a(e);const i=e.data,o=JSON.parse(i);o.imageUrl=`${n.qiniuBucketURLPrefix}/${o.key}`,u(o)}catch(e){a(e)}},fail:e=>{a(e)}});p.onProgressUpdate((e=>{o&&o(e)})),t&&t((()=>{p.abort()}))}))}({filePath:e,options:i,progress:a,cancelTask:s});l(p)}catch(e){c(e)}}))}return i})()}));